<!DOCTYPE html>
<html lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta charset="utf-8">
    <title>Yelp OAuth Example</title>

    <!-- essential to show map:  -->
    <link href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css" rel="stylesheet">
    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        width: 400px;
        height: 400px;
      }
      #list-view {
        height:400px;
      }
      /*use rem font to make font bigger and relative to parent's font*/
      ul li,
      h5 {
        font-size: 2.0rem;
      }
      /*size the infowindow to be able to fit in the map*/
      #siteUrl {
        width: 220px;
        height: 50px;
      }
      .tableColumn {
        width: 100px;
      }
      .thePlace {
        background-color: red;
      }
    </style>

    <script src="http://code.jquery.com/jquery-1.11.1.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAt9NmLDjWl_kQngI0jq0BPA3QUXuMQM_I"></script>
    <script src="js/lib/knockout-3.2.0.js"></script>
    <script src="http://oauth.googlecode.com/svn/code/javascript/oauth.js"></script>
    <script src="http://oauth.googlecode.com/svn/code/javascript/sha1.js"></script>
  </head>

  <body>
    <div class="container">
      <div class="row laCiudad">
          <h1> San Antonio Retirement Homes </h1>
          <!-- the search bar -->
          <div class="col-md-6">
            <h2>Search Bar</h2>
            <h5> type something below to see the list of retirement homes</h5>
            <input id="search" type="search" placeholder="San Antonio retirement homes" name="q" data-bind="value: query,valueUpdate: 'keyup'" autocomplete="off">

          <!-- the list-view -->
            <h2>List View</h2>
            <table>
              <thead>
                <tr>
                  <td class="tableColumn"> name </td>
                  <td class="tableColumn"> lat </td>
                  <td class="tableColumn"> lon </td>
                </tr>
              </thead>
              <tbody data-bind="foreach: searchResults">
                <tr class="info">
                  <td data-bind="text:name, click:$parent.placeClicked" class="name"></td><!-- TODO -->
                  <td data-bind="text:lat"></td>
                  <td data-bind="text:lon"></td>
                </tr>
              </tbody>
            </table>
            <br>

            <!-- a section to display the clicked place -->
            <section>Welcome to San Antonio<span data-bind="text:currentPlace().name"></span>!</section>
          </div>

          <!-- the map and the markers -->
          <div class="col-md-6">
              <h2>Map</h2>
              <div id="map"></div>
          </div>
    </div>

    <script>
      $(function() {
        //create a global map named map1 for later addition of markers
        var map1;
        function createMap(){
          var myOptions = {
              zoom: 10,
              center: new google.maps.LatLng(29.54, -98.51),
              mapTypeId: "terrain"
          };
          map1 = new google.maps.Map($("#map")[0], myOptions);
        };
        createMap();

        //set a global infowindow-set as global so that only one infowindow opens, vs. one infowindow for each marker
        var infowindow = new google.maps.InfoWindow();

        //set up a class called Place for later construction of place objects; it is essential to declare the name as ko.observable since we want to display the names. So is with lat and lon since we want to display the markers, a derivative of lat and lon; if lat or lon is not declared ko.observable, the markers would not show. The marker property is added so that it can be accessed in the marker construction function showMarker and filtering function searchResults.
        var Place = function(data) {
          this.name = ko.observable(data.name);
          this.lat = ko.observable(data.location.coordinate.latitude);
          this.lon = ko.observable(data.location.coordinate.longitude);
          this.info = data.url;
          this.marker = {};
          // this.infowindow = {};
        };

        //set up auth tokens for the Yelp request
        var auth = {
          consumerKey: "vJDdZm0QvnzPtjptn4BqSQ",
          consumerSecret: "18nkUx80NEC6qnpQILDZwOfoXgY",
          accessToken: "LTpWUkoGmR443wsVqCuTC_p0RRxwV2Cs",
          accessTokenSecret: "zdDqJZMrhjwQJXqjQYfPYu3vCcw",
          serviceProvider: {
            signatureMethod: "HMAC-SHA1"
          }
        };

        var accessor = {
          consumerSecret: auth.consumerSecret,
          tokenSecret: auth.accessTokenSecret
        };

        //set up the Yelp query
        var terms = "retirement homes";
        var near = "San+Antonio";

        parameters = [];
        parameters.push(["term", terms]);
        parameters.push(["location", near]);
        parameters.push(["limit", 6]);
        parameters.push(["callback", "cb"]);
        parameters.push(["oauth_consumer_key", auth.consumerKey]);
        parameters.push(["oauth_consumer_secret", auth.consumerSecret]);
        parameters.push(["oauth_token", auth.accessToken]);
        parameters.push(["oauth_signature_method", "HMAC-SHA1"]);

        var message = {
          "action": "http://api.yelp.com/v2/search",
          "method": "GET",
          "parameters": parameters
        };

        OAuth.setTimestampAndNonce(message);
        OAuth.SignatureMethod.sign(message, accessor);
        var parameterMap = OAuth.getParameterMap(message.parameters);
        parameterMap.oauth_signature = OAuth.percentEncode(parameterMap.oauth_signature);
        // console.log(parameterMap);this works

        function MyViewModel() {
          var self = this;

          self.query = ko.observable('');
          self.placeList = ko.observableArray([]);
          self.currentPlace = ko.observable('');

          $.ajax({
            "url": message.action,
            "data": parameterMap,
            "cache": true,
            "dataType": "jsonp",
            "jsonpCallback": "cb",
            "success":function(data) {
              data.businesses.forEach(function(business) {
                self.placeList.push(new Place(business));//not placeList() per NathanM
                //call live update of the list here
                // self.searchResults();
              });//foreach
              //call showMarker here
              self.showMarker(self.placeList());
            },//success
            error: function(exception) {
              alert("data not available at present");
            }
          });//.ajax

          //define a function for use in showMarker; if use Animation.BOUNCE the bounce persists
          function bounceOnce() {
            if (this.getAnimation() !== null) {
              this.setAnimation(null);
            } else {
              this.setAnimation(google.maps.Animation.DROP);
            }
          };

          //insert marker with view model instead of custom binding per suggestion of Udacity student leader mcs
          self.showMarker = function(anArray) {
            anArray.map(function(currentValue, index, array) {
              //construct and show marker
              var markerObject = {};
              markerObject.position = {lat: currentValue.lat(), lng: currentValue.lon()};
              markerObject.map = map1;
              markerObject.animation = google.maps.Animation.DROP;
              array[index].marker = new google.maps.Marker(markerObject);
              //make the marker bounce on click
              array[index].marker.addListener('click', bounceOnce);

              //create an info content for display in the infowindow
              var contentString =
                '<div id="content">'+
                    '<h4 id="firstHeading" class="firstHeading">Url</h4>'+
                    '<div id="siteUrl">'+currentValue.info+'</div>'+
                '</div>';
              //show info window for each marker when clicked
              google.maps.event.addListener(currentValue.marker,'click',function() {
                infowindow.setContent(contentString);
                infowindow.open(map1,this);
              });
            });//map
          };//showMarker

          //The live filtering function has to be placed near the end;
          self.searchResults = ko.computed(function(){
            //filter the list
            if(!self.query()) {
              return self.placeList();
            } else {
              var search = self.query().toLowerCase();//use a search variable for performance per Karol @ Udacity forum
              //hide a marker if its location name does not appear in the user input
              self.placeList().forEach(function(currentValue,index,array) {
                if (currentValue.name().toLowerCase().indexOf(search) === -1)
                  currentValue.marker.setVisible(false);
              });
              //filter the list view based on the user input
              return ko.utils.arrayFilter(self.placeList(), function(place){
                 return place.name().toLowerCase().indexOf(search) >= 0;
              });
            }//else
          },this);//TODO:this is optional here. I guess because "self" is used.

          //define what happens when a place in the list is clicked:asign it to a welcome message display object.
          self.placeClicked = function() {
            self.currentPlace(this);
          };
        };//MyViewModel

        var viewModel = new MyViewModel();
        ko.applyBindings(viewModel);
      });
    </script>
  </body>
</html>